"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var find = require("find");
var fileinfo = require("filenameinfo");
var Promise = require("bluebird");
var async = require("async");
var unicoid_1 = require("unicoid");
var getFileSize = require('getfilesize');
var getDuration = require('get-video-duration');
var ffmetadata = require("ffmetadata");
function list(path, config) {
    function createuid(array) {
        var exists = false;
        var uid = unicoid_1.uniqueid(8);
        for (var i = 0; i < array.length; i++) {
            if (array[i].uid === uid) {
                exists = true;
            }
        }
        if (exists) {
            return createuid(array);
        }
        else {
            return uid;
        }
    }
    return new Promise(function (resolve, reject) {
        find.file(path, function (files) {
            var media = [];
            for (var i = 0; i < files.length; i++) {
                if (parseInt(getFileSize(files[0])) && parseInt(getFileSize(files[0])) > 0) {
                    console.log('check ' + files[0], getFileSize(files[0]));
                    var m = fileinfo.filenameinfo(files[i]);
                    if (m.extensionFamily === 'video' || m.extensionFamily === 'audio') {
                        m.uid = createuid(media);
                        if (config && config.serverUri && config.serverUri.path && config.serverUri.uri && m.path.split(config.serverUri.path).length > 1 && m.path.split(config.serverUri.path)[0] === '') {
                            m.uri = config.serverUri.uri + m.path.split(config.serverUri.path)[1];
                        }
                    }
                }
            }
            async.eachSeries(media, function (m, cb) {
                console.log('duration', m);
                getDuration(m.path).then(function (a) {
                    m.duration = a;
                    ffmetadata.read(m.path, function (err, data) {
                        if (err) {
                            cb("Error reading metadata");
                        }
                        else {
                            m.meta = data;
                            cb();
                        }
                        ;
                    });
                }).catch(function (err) {
                    cb(err);
                });
            }, function (err) {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(media);
                }
            });
        }).error(function (err) {
            if (err) {
                reject(err);
            }
            else {
                reject('find error');
            }
        });
    });
}
exports.list = list;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsQ0FBQTtRQUlKLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUc7WUFDcEIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDUixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDYixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQ3RCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQTtJQUlKLENBQUMsQ0FBQyxDQUFBO0FBSUosQ0FBQztBQS9GRCxvQkErRkMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmaW5kIGZyb20gJ2ZpbmQnXG5pbXBvcnQgKiBhcyBmaWxlaW5mbyBmcm9tICdmaWxlbmFtZWluZm8nXG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0ICogYXMgYXN5bmMgZnJvbSAnYXN5bmMnXG5pbXBvcnQgeyB1bmlxdWVpZCB9IGZyb20gJ3VuaWNvaWQnXG5cbmNvbnN0IGdldEZpbGVTaXplID0gcmVxdWlyZSgnZ2V0ZmlsZXNpemUnKTtcblxuXG5jb25zdCBnZXREdXJhdGlvbiA9IHJlcXVpcmUoJ2dldC12aWRlby1kdXJhdGlvbicpO1xuY29uc3QgZmZtZXRhZGF0YSA9IHJlcXVpcmUoXCJmZm1ldGFkYXRhXCIpO1xuXG5cbmludGVyZmFjZSBJTWVkaWFGaWxlSW5mb0NvbmYge1xuICBmb3JtYXRzPzogc3RyaW5nW11cbiAgZXhjbHVkZT86IHN0cmluZ1tdXG4gIHNlcnZlclVyaT86IHsgcGF0aDogc3RyaW5nLCB1cmk6IHN0cmluZyB9XG59XG5pbnRlcmZhY2UgSU1lZGlhRmlsZVJlc3Age1xuICBtZXRhOiBJTWVkaWFGaWxlTWV0YVxuICBkdXJhdGlvbjogc3RyaW5nXG4gIHBhdGg6IHN0cmluZ1xuICBmdWxsbmFtZTogc3RyaW5nXG4gIG5hbWU6IHN0cmluZ1xuICBleHRlbnNpb246IHN0cmluZ1xuICBkaXI6IHN0cmluZ1xuICBleHRlbnNpb25GYW1pbHk6IHN0cmluZ1xuICBleHRlbnNpb25UeXBlOiBzdHJpbmdcbiAgdWlkOiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIElNZWRpYUZpbGVNZXRhIHtcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gbGlzdChwYXRoOiBzdHJpbmcsIGNvbmZpZz86IElNZWRpYUZpbGVJbmZvQ29uZikge1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZXVpZChhcnJheSkge1xuICAgIGxldCBleGlzdHMgPSBmYWxzZVxuICAgIGNvbnN0IHVpZCA9IHVuaXF1ZWlkKDgpXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGFycmF5W2ldLnVpZCA9PT0gdWlkKSB7XG4gICAgICAgIGV4aXN0cyA9IHRydWVcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoZXhpc3RzKSB7XG4gICAgICByZXR1cm4gY3JlYXRldWlkKGFycmF5KVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdWlkXG4gICAgfVxuXG4gIH1cblxuICByZXR1cm4gbmV3IFByb21pc2U8SU1lZGlhRmlsZVJlc3BbXT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgZmluZC5maWxlKHBhdGgsIGZ1bmN0aW9uIChmaWxlcykge1xuXG5cbiAgICAgIGNvbnN0IG1lZGlhOiBJTWVkaWFGaWxlUmVzcFtdID0gW11cblxuXG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsZXMubGVuZ3RoOyBpKyspIHtcblxuICAgICAgICBpZiAocGFyc2VJbnQoZ2V0RmlsZVNpemUoZmlsZXNbMF0pKSAmJiBwYXJzZUludChnZXRGaWxlU2l6ZShmaWxlc1swXSkpID4gMCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdjaGVjayAnICsgZmlsZXNbMF0sIGdldEZpbGVTaXplKGZpbGVzWzBdKSlcbiAgICAgICAgICBjb25zdCBtOiBhbnkgPSBmaWxlaW5mby5maWxlbmFtZWluZm8oZmlsZXNbaV0pXG4gICAgICAgICAgaWYgKG0uZXh0ZW5zaW9uRmFtaWx5ID09PSAndmlkZW8nIHx8IG0uZXh0ZW5zaW9uRmFtaWx5ID09PSAnYXVkaW8nKSB7XG5cblxuICAgICAgICAgICAgbS51aWQgPSBjcmVhdGV1aWQobWVkaWEpXG5cbiAgICAgICAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLnNlcnZlclVyaSAmJiBjb25maWcuc2VydmVyVXJpLnBhdGggJiYgY29uZmlnLnNlcnZlclVyaS51cmkgJiYgbS5wYXRoLnNwbGl0KGNvbmZpZy5zZXJ2ZXJVcmkucGF0aCkubGVuZ3RoID4gMSAmJiBtLnBhdGguc3BsaXQoY29uZmlnLnNlcnZlclVyaS5wYXRoKVswXSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgbS51cmkgPSBjb25maWcuc2VydmVyVXJpLnVyaSArIG0ucGF0aC5zcGxpdChjb25maWcuc2VydmVyVXJpLnBhdGgpWzFdXG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgLy8gbWVkaWEucHVzaChtKVxuXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cblxuXG5cbiAgICAgIH1cblxuXG5cbiAgICAgIGFzeW5jLmVhY2hTZXJpZXMobWVkaWEsIChtLCBjYikgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZygnZHVyYXRpb24nLCBtKVxuICAgICAgICBnZXREdXJhdGlvbihtLnBhdGgpLnRoZW4oKGEpID0+IHtcbiAgICAgICAgICBtLmR1cmF0aW9uID0gYVxuICAgICAgICAgIGZmbWV0YWRhdGEucmVhZChtLnBhdGgsIGZ1bmN0aW9uIChlcnIsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgY2IoXCJFcnJvciByZWFkaW5nIG1ldGFkYXRhXCIpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBtLm1ldGEgPSBkYXRhXG4gICAgICAgICAgICAgIGNiKClcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgIGNiKGVycilcbiAgICAgICAgfSlcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZShtZWRpYSlcbiAgICAgICAgfVxuICAgICAgfSlcblxuXG5cbiAgICB9KS5lcnJvcihmdW5jdGlvbiAoZXJyKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJlamVjdChlcnIpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZWplY3QoJ2ZpbmQgZXJyb3InKVxuICAgICAgfVxuICAgIH0pXG5cblxuXG4gIH0pXG5cblxuXG59XG5cblxuIl19
